<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Matriz AHP</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-messages">
                {% for category, message in messages %}
                    <div class="flash flash-{{ category }}">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <div class="container">
        <h1>üéØ An√°lisis Jer√°rquico (AHP)</h1>
        
        <h3>Llena la matriz de comparaci√≥n por pares</h3>
        <p style="color: #7f8c8d; margin-bottom: 20px;">
            <strong>Escala:</strong> 1 = Igual importancia | 3 = Moderadamente m√°s importante | 
            5 = Fuertemente m√°s importante | 7 = Muy fuertemente m√°s importante | 
            9 = Extremadamente m√°s importante<br>
            <em>üí° Tip: Puedes usar fracciones como 1/3, 1/2, etc.</em>
        </p>
        
        <form method="POST">
            <table class="matrix-table">
                <thead>
                    <tr>
                        <th></th>
                        {% for c in criterios %}
                            <th>{{ c }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for i in range(num_criterios) %}
                    <tr>
                        <th>{{ criterios[i] }}</th>
                        {% for j in range(num_criterios) %}
                            <td>
                                <input type="text"
                                       name="cell_{{ i }}_{{ j }}"
                                       class="ahp-input"
                                       value="{{ '1.00' if i == j else '' }}"
                                       onblur="convertirFraccion(this)"
                                       oninput="validarEntrada(this)"
                                       {% if i == j %}readonly style="background: #ecf0f1; font-weight: bold;"{% endif %}
                                       required>
                            </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <div class="btn-container">
                <button type="submit">üßÆ Calcular pesos</button>
            </div>
        </form>

        {% if pesos is not none %}
        <hr>
        
        <h3>‚úÖ Pesos calculados con AHP</h3>
        
        <table class="result-table">
            <thead>
                <tr>
                    <th>CRITERIO</th>
                    <th>PESO</th>
                </tr>
            </thead>
            <tbody>
                {% for i in range(criterios|length) %}
                <tr>
                    <td><strong>{{ criterios[i] }}</strong></td>
                    <td>{{ "%.4f"|format(pesos[i]) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div class="btn-container">
            <a href="{{ url_for('routes.alternativas') }}" class="btn">‚û°Ô∏è Continuar con TOPSIS</a>
        </div>
        {% endif %}
    </div>

    <script>
    function validarEntrada(input) {
        
        input.value = input.value.replace(/[^0-9.\/]/g, '');
        
        
        const puntos = (input.value.match(/\./g) || []).length;
        const barras = (input.value.match(/\//g) || []).length;
        
        if (puntos > 1) {
            input.value = input.value.substring(0, input.value.lastIndexOf('.'));
        }
        
        if (barras > 1) {
            input.value = input.value.substring(0, input.value.lastIndexOf('/'));
        }
    }

    function convertirFraccion(input) {
        
        if (input.value === '' || input.readOnly) return;
        
        const valor = input.value.trim();
        
        
        if (valor.includes('/')) {
            try {
                const partes = valor.split('/');
                const numerador = parseFloat(partes[0]);
                const denominador = parseFloat(partes[1]);
                
                // Validar que sean n√∫meros v√°lidos
                if (isNaN(numerador) || isNaN(denominador) || denominador === 0) {
                    input.value = '';
                    alert('‚ö†Ô∏è Fracci√≥n inv√°lida. Usa formato: numerador/denominador (ej: 1/3)');
                    input.focus();
                    return;
                }
                
                const resultado = numerador / denominador;
                
                
                if (resultado < 0.11 || resultado > 9) {
                    input.value = '';
                    alert('‚ö†Ô∏è El valor debe estar entre 0.11 y 9');
                    input.focus();
                    return;
                }
                
                input.value = resultado.toFixed(2);
                
                input.style.background = '#d5f4e6';
                setTimeout(() => {
                    input.style.background = '';
                }, 500);
                
            } catch (error) {
                input.value = '';
                alert('‚ö†Ô∏è Error al convertir la fracci√≥n');
                input.focus();
            }
        } else {
            const numero = parseFloat(valor);
            
            if (isNaN(numero)) {
                input.value = '';
                alert('‚ö†Ô∏è Por favor ingresa un n√∫mero v√°lido');
                input.focus();
                return;
            }
            
            if (numero < 0.11 || numero > 9) {
                input.value = '';
                alert('‚ö†Ô∏è El valor debe estar entre 0.11 y 9');
                input.focus();
                return;
            }
            
            input.value = numero.toFixed(2);
        }
    }

    document.querySelector('form').addEventListener('submit', function(e) {
        const inputs = document.querySelectorAll('.ahp-input:not([readonly])');
        let valido = true;
        
        inputs.forEach(input => {
            if (input.value === '') {
                valido = false;
                input.style.border = '2px solid red';
            } else {
                input.style.border = '';
            }
        });
        
        if (!valido) {
            e.preventDefault();
            alert('‚ö†Ô∏è Por favor completa todos los campos de la matriz');
        }
    });
    </script>
</body>
</html>